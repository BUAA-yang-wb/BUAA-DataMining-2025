# 多模态异常检测Transformer

一个基于Transformer的统一多模态异常检测框架，能够同时处理图像异常检测（Task2）和无监督疾病判断（Task4）任务。

## 🎯 项目概述

本项目实现了一个创新的多模态异常检测系统，通过统一的Transformer架构同时学习图像和数值数据的异常检测模式。系统采用半监督学习策略，只使用正常样本进行训练，能够有效识别两种模态的异常样本。

### 主要特性

- ✅ **统一架构** - 单个模型同时处理图像和数值异常检测
- ✅ **半监督学习** - 只使用正常样本训练
- ✅ **实时监控** - 训练过程指标监控和日志记录
- ✅ **全面评估** - 多维度性能评估和可视化
- ✅ **易于使用** - 完整的训练和测试脚本

## 🧠 设计思路

### 核心理念

传统的异常检测通常针对单一模态（如纯图像或纯数值），但现实世界的异常检测任务往往涉及多种数据类型。本项目提出**统一的多模态异常检测框架**，通过Transformer的强大特征学习能力和跨模态注意力机制，实现：

1. **模态统一** - 将图像和数值数据映射到统一的特征空间
2. **知识共享** - 不同模态间的特征学习相互促进
3. **异常泛化** - 学习通用的异常检测模式

### 架构设计

#### 1. 多模态Patch嵌入层
```
图像输入 → 卷积分块 → Token嵌入
数值输入 → 线性投影 → Token嵌入
     ↓
  模态类型嵌入 → 位置嵌入 → Transformer输入
```

#### 2. 跨模态Transformer编码器
- **多头自注意力** - 学习token间的复杂关系
- **前馈网络** - 非线性特征变换
- **残差连接** - 保持梯度流动

#### 3. 异常检测头
```
CLS Token → 重构预测 → MSE损失 (重建误差)
         → 异常评分 → Sigmoid损失 (异常概率)
```

### 训练策略

- **数据划分**: 训练集(正常样本) + 验证集(混合样本) + 测试集(混合样本)
- **交替训练**: 图像批次 → 数值批次 → 验证评估，每轮自动保存最佳模型
- **损失函数**: 重构误差 + 异常分数联合优化

## 🚀 快速开始

### 环境准备
```bash
pip install -r requirements.txt
```

### 数据集
项目使用两个公开数据集：
- **图像异常检测**: hazelnut + zipper 数据集 (400训练 + 102测试)
- **数值异常检测**: 甲状腺疾病数据集 (1839训练 + 1933测试)

### 训练模型
```bash
# 推荐配置 (30轮, 批次大小8)
python demo.py --epochs 30 --batch_size 8

# 继续训练现有模型
python demo.py --resume results/best_model_checkpoint.pth --epochs 50
```

### 测试模型
```bash
# 使用最佳模型进行测试
python test_model.py --checkpoint results/best_model_checkpoint.pth

# 示例输出:
# Task2图像异常检测: AUC 0.7188, 精确率 1.0000, 召回率 0.2500
# Task4数值异常检测: AUC 0.9577, 精确率 0.6538, 召回率 0.6711
```

### 训练过程
```
分别训练Task2和Task4...
Epoch 1/30: 图像训练 → 数值训练 → 验证评估
...
Epoch 30/30: 图像训练 → 数值训练 → 验证评估
训练完成 - 最佳模型已保存 (best_model_checkpoint.pth)
```

### 输出文件
训练完成后将在 `results/` 目录生成：
- `best_model_checkpoint.pth`: 最佳模型权重
- `multimodal_training_*.log`: 详细训练日志
- 各类性能图表和评估报告

## 📊 实验结果

| 任务 | AUC | 精确率 | 召回率 | F1分数 | 准确率 |
|------|-----|--------|--------|--------|--------|
| **Task2图像** | 0.7188 | 1.0000 | 0.2500 | 0.4000 | 0.7955 |
| **Task4数值** | 0.9577 | 0.6538 | 0.6711 | 0.6623 | 0.9664 |

- **Task4数值任务**：AUC 0.9577，表现出色，适合实际部署
- **Task2图像任务**：AUC 0.7188，性能有所提升，精确率保持完美但召回率仍待优化

## 📁 项目结构

```
├── demo.py                 # 主训练脚本
├── test_model.py          # 模型测试脚本
├── multimodal_anomaly_detector.py  # 核心模型实现
├── config.py              # 配置管理
├── logger.py              # 日志记录器
├── visualization.py       # 可视化工具
├── requirements.txt       # 依赖包列表
├── data/                  # 数据目录 (图像+数值)
└── results/               # 输出结果目录 (模型+日志+图表)
```

